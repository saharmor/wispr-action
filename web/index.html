<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wispr Action - Voice Command Manager</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-title-wrapper">
                    <img src="logo.png" alt="Wispr Logo" class="header-logo">
                    <div class="header-text">
                        <h1>Wispr Action</h1>
                        <p class="subtitle">Voice Command Manager</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <div class="monitor-status">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">Checking...</span>
                </div>
                <button id="toggleMonitorBtn" class="btn btn-primary">Start Monitor</button>
                <button id="newCommandBtn" class="btn btn-success">+ New Command</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Command List -->
            <section class="command-list-section" id="commandListSection">
                <div class="section-header">
                    <div class="view-tabs">
                        <button class="view-tab active" id="commandsTab" onclick="switchView('commands')">Commands</button>
                        <button class="view-tab" id="historyTab" onclick="switchView('history')">History</button>
                    </div>
                    <span class="command-count" id="commandCount">0 commands</span>
                </div>
                
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon"></div>
                    <h3>No commands yet</h3>
                    <p>Create your first voice command to get started</p>
                    <button class="btn btn-primary" onclick="showCommandEditor()">Create Command</button>
                </div>

                <div class="command-table-container" id="commandTableContainer" style="display: none;">
                    <table class="command-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Examples</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="commandTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- History Section -->
            <section class="command-list-section" id="historySection" style="display: none;">
                <div class="section-header">
                    <div class="view-tabs">
                        <button class="view-tab" id="commandsTab2" onclick="switchView('commands')">Commands</button>
                        <button class="view-tab active" id="historyTab2" onclick="switchView('history')">History</button>
                    </div>
                </div>

                <div class="empty-state" id="historyEmptyState">
                    <div class="empty-icon">üìã</div>
                    <h3>No command history yet</h3>
                    <p>Execute a command to see it here</p>
                </div>

                <div class="history-table-container" id="historyTableContainer" style="display: none;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Command</th>
                                <th>Parameters</th>
                                <th>Status</th>
                                <th>Output</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                        </tbody>
                    </table>
                    <div class="load-more-container">
                        <button id="loadMoreHistoryBtn" class="btn btn-secondary" onclick="loadMoreHistory()" style="display: none;">Load More</button>
                    </div>
                </div>
            </section>

            <!-- Test Panel -->
            <section class="test-panel">
                <h3>Test Command</h3>
                <div class="test-input-group">
                    <textarea 
                        id="testPhrase" 
                        placeholder="Type a test phrase, e.g., 'command, run email processor for sahar@gmail.com'"
                        rows="3"
                    ></textarea>
                    <button id="testParseBtn" class="btn btn-primary">Parse Command</button>
                </div>
                <div class="test-result" id="testResult" style="display: none;">
                    <div class="result-header">
                        <strong>Result:</strong>
                    </div>
                    <div id="testResultContent"></div>
                    <button id="testExecuteBtn" class="btn btn-secondary" style="display: none;">Execute</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Command Editor Panel (Slide-in) -->
    <div class="editor-overlay" id="editorOverlay">
        <div class="editor-panel" id="editorPanel">
            <div class="editor-header">
                <h2 id="editorTitle">New Command</h2>
                <button class="close-btn" onclick="closeCommandEditor()">&times;</button>
            </div>

            <div class="editor-content">
                <!-- Section 1: Basics -->
                <section class="editor-section">
                    <h3>General</h3>
                    <div class="form-group">
                        <label for="cmdName">Command Name *</label>
                        <input type="text" id="cmdName" placeholder="e.g., Process Emails" required>
                    </div>
                    <div class="form-group">
                        <label for="cmdDescription">Description *</label>
                        <textarea id="cmdDescription" rows="2" placeholder="What does this command do?" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="cmdTimeout">Timeout (seconds)</label>
                        <input type="number" id="cmdTimeout" min="0" max="600" placeholder="0">
                        <small class="help-text">Maximum execution time. Default: 0 (no timeout).</small>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="cmdRunForeground">
                            <span>Run in foreground?</span>
                        </label>
                        <small class="help-text">Opens a visible terminal window for script execution (useful for debugging)</small>
                    </div>
                </section>


                <!-- Section 3: Parameters -->
                <section class="editor-section">
                    <h3>Parameters</h3>
                    <div class="params-table-container">
                        <table class="params-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Required</th>
                                    <th>Description</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="paramsTableBody">
                                <tr class="param-row">
                                    <td><input type="text" class="param-name" placeholder="e.g. email, location, etc." oninput="updateArgsTemplatePlaceholder()"></td>
                                    <td>
                                        <select class="param-type">
                                            <option value="string">string</option>
                                            <option value="number">number</option>
                                            <option value="email">email</option>
                                            <option value="url">url</option>
                                            <option value="boolean">boolean</option>
                                        </select>
                                    </td>
                                    <td><input type="checkbox" class="param-required"></td>
                                    <td><input type="text" class="param-description" placeholder="The email address"></td>
                                    <td><button class="btn-icon" onclick="removeParam(this)">‚àí</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-sm" onclick="addParam()">+ Add Parameter</button>
                </section>

                <!-- Section Examples -->
                <section class="editor-section">
                    <h3>Example Phrases (Optional)</h3>
                    <p class="help-text">Provide 2-5 example phrases to help the AI understand your command</p>
                    <div id="examplesContainer">
                        <div class="example-row">
                            <input type="text" class="example-input" placeholder="e.g., 'run emails for sahar@gmail.com'">
                            <button class="btn-icon" onclick="removeExample(this)">‚àí</button>
                        </div>
                    </div>
                    <button class="btn btn-sm" onclick="addExample()">+ Add Example</button>
                </section>

                <!-- Section 4: Action -->
                <section class="editor-section">
                    <h3>Action</h3>
                    <div class="action-type-selector">
                        <label class="radio-label">
                            <input type="radio" name="actionType" value="script" checked onchange="toggleActionType()">
                            <span>Run Script</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="actionType" value="http" onchange="toggleActionType()">
                            <span>Call HTTP</span>
                        </label>
                    </div>

                    <!-- Script Action -->
                    <div id="scriptAction" class="action-config">
                        <div class="form-group">
                            <label for="scriptPath">Script Path *</label>
                            <input type="text" id="scriptPath" placeholder="~/scripts/process_emails.py">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="showLaunchJsonImporter()" style="margin-top: 8px;">
                                üìã Import from launch.json
                            </button>
                        </div>
                        <div class="form-group">
                            <label for="argsTemplate">Arguments Template</label>
                            <input type="text" id="argsTemplate" placeholder="Define parameters above to see examples">
                            <small class="help-text" id="scriptHelpText">
                                Use <code>{param_name}</code> to reference parameters. 
                                <strong>For optional parameters</strong>, wrap them in brackets: <code>[--flag={optional_param}]</code>.
                                <br>Examples: <code>--email={email} [--days={days}]</code> or <code>{file} [--format={format}]</code>
                            </small>
                        </div>
                        
                        <!-- Python-specific options (collapsible) -->
                        <div class="collapsible-section">
                            <button type="button" class="collapsible-toggle" onclick="togglePythonOptions(event)">
                                <span class="toggle-icon">‚ñ∂</span>
                                Python Environment (Optional)
                            </button>
                            <div class="collapsible-content" id="pythonOptions">
                                <div class="form-group">
                                    <label for="workingDirectory">Working Directory</label>
                                    <div class="input-with-button">
                                        <input type="text" id="workingDirectory" placeholder="~/project">
                                        <button type="button" class="btn-icon-secondary" onclick="pickDirectory('workingDirectory')" title="Browse for directory">üìÅ</button>
                                    </div>
                                    <small class="help-text">Directory to run the script from</small>
                                </div>
                                <div class="form-group">
                                    <label for="pythonInterpreter">Python Interpreter</label>
                                    <input type="text" id="pythonInterpreter" placeholder="venv/bin/python or ~/project/venv/bin/python">
                                    <small class="help-text">Path to Python interpreter (absolute, relative to working directory, or using ~). Leave empty to use script's shebang.</small>
                                </div>
                                <div class="form-group">
                                    <label for="envFile">Environment File</label>
                                    <input type="text" id="envFile" placeholder="~/project/.env">
                                    <small class="help-text">Path to .env file to load environment variables from</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- HTTP Action -->
                    <div id="httpAction" class="action-config" style="display: none;">
                        <div class="form-group">
                            <label for="httpMethod">Method</label>
                            <select id="httpMethod">
                                <option value="GET">GET</option>
                                <option value="POST" selected>POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="httpUrl">URL *</label>
                            <input type="text" id="httpUrl" placeholder="http://localhost:3000/api/music/play">
                        </div>
                        <div class="form-group">
                            <label>Headers (Optional)</label>
                            <div id="headersContainer">
                                <div class="header-row">
                                    <input type="text" class="header-key" placeholder="Content-Type">
                                    <input type="text" class="header-value" placeholder="application/json">
                                    <button class="btn-icon" onclick="removeHeader(this)">‚àí</button>
                                </div>
                            </div>
                            <button class="btn btn-sm" onclick="addHeader()">+ Add Header</button>
                        </div>
                        <div class="form-group">
                            <label for="httpBody">Body Template (JSON)</label>
                            <textarea id="httpBody" rows="4" placeholder='{"query": "{query}"}'></textarea>
                            <small class="help-text" id="httpHelpText">
                                Use <code>{param_name}</code> for parameters. 
                                <strong>For optional fields</strong>, wrap in brackets: <code>{"text": "{text}"[, "title": "{title}"]}</code>
                            </small>
                        </div>
                    </div>
                </section>
            </div>

            <div class="editor-footer">
                <button class="btn btn-secondary" onclick="closeCommandEditor()">Cancel</button>
                <button class="btn btn-primary" id="saveCommandBtn" onclick="saveCommand()">Save Command</button>
            </div>
        </div>
    </div>

    <!-- Modal Component -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon"></div>
                <h3 class="modal-title" id="modalTitle"></h3>
                <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-message" id="modalMessage"></p>
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Launch.json Importer Modal -->
    <div class="modal-overlay" id="launchJsonModal">
        <div class="modal-container" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Import from launch.json</h3>
                <button class="modal-close" onclick="closeLaunchJsonImporter()" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-medium); margin-bottom: 16px;">
                    Paste a launch.json configuration entry below and we'll automatically fill in the fields:
                </p>
                <textarea 
                    id="launchJsonInput" 
                    placeholder='{\n  "name": "My Script",\n  "program": "${workspaceFolder}/path/to/script.py",\n  "python": "${workspaceFolder}/venv/bin/python",\n  "envFile": "${workspaceFolder}/.env",\n  "args": ["arg1", "arg2"]\n}'
                    rows="12"
                    style="width: 100%; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; padding: 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm);"
                ></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLaunchJsonImporter()">Cancel</button>
                <button class="btn btn-primary" onclick="importLaunchJson()">Import</button>
            </div>
        </div>
    </div>

    <script src="app.js" defer></script>
</body>
</html>

